name: "ðŸ”„ VÃ©rification mises Ã  jour Node-RED"

on:
  schedule:
    # VÃ©rifie chaque lundi Ã  8h00
    - cron: "0 8 * * 1"
  workflow_dispatch:
    # Permet aussi de lancer manuellement depuis GitHub

jobs:
  check-update:
    name: "VÃ©rifier Node-RED + serialport"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout du repo"
        uses: actions/checkout@v4

      - name: "ðŸ” RÃ©cupÃ©rer les versions actuelles"
        id: current
        run: |
          # Version Node-RED dans le Dockerfile
          CURRENT_NR=$(grep -oP 'node-red@\K[0-9]+\.[0-9]+\.[0-9]+' Dockerfile)
          echo "nodered=$CURRENT_NR" >> $GITHUB_OUTPUT
          echo "âœ… Node-RED actuel : $CURRENT_NR"

          # Version node-red-node-serialport dans le Dockerfile
          CURRENT_SP=$(grep -oP 'node-red-node-serialport@\K[0-9]+\.[0-9]+\.[0-9]+' Dockerfile || echo "")
          echo "serialport=$CURRENT_SP" >> $GITHUB_OUTPUT
          echo "âœ… Serialport actuel : ${CURRENT_SP:-non versionnÃ©}"

      - name: "ðŸŒ RÃ©cupÃ©rer les derniÃ¨res versions sur npm"
        id: latest
        run: |
          # DerniÃ¨re version stable de Node-RED
          LATEST_NR=$(npm show node-red version)
          echo "nodered=$LATEST_NR" >> $GITHUB_OUTPUT
          echo "ðŸ†• Node-RED latest : $LATEST_NR"

          # DerniÃ¨re version de node-red-node-serialport
          LATEST_SP=$(npm show node-red-node-serialport version)
          echo "serialport=$LATEST_SP" >> $GITHUB_OUTPUT
          echo "ðŸ†• Serialport latest : $LATEST_SP"

      - name: "ðŸ“ Mettre Ã  jour le Dockerfile si nÃ©cessaire"
        id: update
        run: |
          CHANGED=false

          # Mettre Ã  jour Node-RED si nouvelle version
          if [ "${{ steps.current.outputs.nodered }}" != "${{ steps.latest.outputs.nodered }}" ]; then
            echo "ðŸ”„ Mise Ã  jour Node-RED : ${{ steps.current.outputs.nodered }} -> ${{ steps.latest.outputs.nodered }}"
            sed -i "s/node-red@${{ steps.current.outputs.nodered }}/node-red@${{ steps.latest.outputs.nodered }}/g" Dockerfile
            CHANGED=true
          else
            echo "âœ… Node-RED dÃ©jÃ  Ã  jour (${{ steps.current.outputs.nodered }})"
          fi

          # Mettre Ã  jour serialport si il est versionnÃ© et qu'une nouvelle version existe
          if [ -n "${{ steps.current.outputs.serialport }}" ] && \
             [ "${{ steps.current.outputs.serialport }}" != "${{ steps.latest.outputs.serialport }}" ]; then
            echo "ðŸ”„ Mise Ã  jour serialport : ${{ steps.current.outputs.serialport }} -> ${{ steps.latest.outputs.serialport }}"
            sed -i "s/node-red-node-serialport@${{ steps.current.outputs.serialport }}/node-red-node-serialport@${{ steps.latest.outputs.serialport }}/g" Dockerfile
            CHANGED=true
          else
            echo "âœ… Serialport dÃ©jÃ  Ã  jour"
          fi

          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: "ðŸš€ CrÃ©er la Pull Request"
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ Mise Ã  jour automatique des dÃ©pendances

            - Node-RED : ${{ steps.current.outputs.nodered }} -> ${{ steps.latest.outputs.nodered }}
            - node-red-node-serialport : ${{ steps.current.outputs.serialport }} -> ${{ steps.latest.outputs.serialport }}
          title: "ðŸ”„ Mise Ã  jour Node-RED ${{ steps.latest.outputs.nodered }}"
          body: |
            ## Mises Ã  jour disponibles ðŸ†•

            | Package | Version actuelle | Nouvelle version |
            |---------|-----------------|-----------------|
            | node-red | `${{ steps.current.outputs.nodered }}` | `${{ steps.latest.outputs.nodered }}` |
            | node-red-node-serialport | `${{ steps.current.outputs.serialport }}` | `${{ steps.latest.outputs.serialport }}` |

            ## âœ… Pour appliquer la mise Ã  jour
            1. VÃ©rifiez les changements dans le Dockerfile
            2. Testez si possible sur votre installation
            3. Cliquez **Merge Pull Request**
            4. L'addon sera automatiquement republiÃ© avec les nouvelles versions

            ## ðŸ“‹ Liens utiles
            - [Changelog Node-RED](https://github.com/node-red/node-red/blob/master/CHANGELOG.md)
            - [Releases node-red-node-serialport](https://github.com/node-red/node-red-nodes/releases)

          branch: "auto-update/nodered-${{ steps.latest.outputs.nodered }}"
          delete-branch: true
          labels: "ðŸ”„ mise Ã  jour automatique"

      - name: "âœ… Aucune mise Ã  jour disponible"
        if: steps.update.outputs.changed == 'false'
        run: echo "Tout est Ã  jour, aucune PR crÃ©Ã©e."
